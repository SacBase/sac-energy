use Array: all;
use CommandLine: all;
use StdIO: all;

noinline
int test()
{
    MTClock::touch();
    Rapl::touch();
    Freq::touch();

    return sum(iota([1000,500,100]));
}

int main()
{
    iter = String::toi(argv(argc() - 1));

    for (i = 0; i < iter; i += 1) {
        cycle_fd = Freq::cyclesStart();
        stall_fd = Stall::stallStart();
        rapl = Rapl::raplStart();
        sec1, nsec1 = MTClock::gettime();

        printf("res = %d\n", test());

        sec2, nsec2 = MTClock::gettime();
        energy_uj = Rapl::raplStop(rapl);
        cycles = Freq::cyclesStop(cycle_fd);
        stalls = Stall::stallStop(stall_fd);

        threads = Rapl::numThreads();
        seconds = MTClock::timediff(sec1, nsec1, sec2, nsec2);
        energy = Rapl::tod(energy_uj);
        printf("%d threads, %fs, %fJ, %lu cycles, %lu stalls\n",
               threads, seconds, energy, cycles, stalls);
    }

    return 0;
}
